name: Exception Expiration Check

on:
  # Run weekly on Monday mornings
  schedule:
    - cron: '0 9 * * 1'

  # Run on changes to exceptions registry
  push:
    paths:
      - 'docs/exceptions.md'

  pull_request:
    paths:
      - 'docs/exceptions.md'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-exceptions:
    name: Check Exception Expirations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for expiring and expired exceptions
        id: check
        run: |
          echo "Checking exception expirations..."

          EXCEPTIONS_FILE="docs/exceptions.md"
          TODAY=$(date +%Y-%m-%d)
          THIRTY_DAYS=$(date -d "+30 days" +%Y-%m-%d)

          echo "Today: $TODAY"
          echo "30 days from now: $THIRTY_DAYS"

          # Initialize tracking variables
          EXPIRED_COUNT=0
          EXPIRING_SOON_COUNT=0
          EXPIRED_LIST=""
          EXPIRING_LIST=""

          # Extract exception entries with expiration dates
          # Look for lines matching "| Expires | YYYY-MM-DD |"
          while IFS= read -r line; do
            if [[ "$line" =~ \|[[:space:]]*Expires[[:space:]]*\|[[:space:]]*([0-9]{4}-[0-9]{2}-[0-9]{2})[[:space:]]*\| ]]; then
              EXPIRATION_DATE="${BASH_REMATCH[1]}"

              # Get the exception ID from nearby context (look back for EXC- pattern)
              # This is a simplified check - in practice, you'd want more robust parsing

              if [[ "$EXPIRATION_DATE" < "$TODAY" ]]; then
                echo "::error::Found expired exception with date: $EXPIRATION_DATE"
                EXPIRED_COUNT=$((EXPIRED_COUNT + 1))
                EXPIRED_LIST="${EXPIRED_LIST}\n- Expiration date: $EXPIRATION_DATE"
              elif [[ "$EXPIRATION_DATE" < "$THIRTY_DAYS" ]]; then
                echo "::warning::Found exception expiring soon: $EXPIRATION_DATE"
                EXPIRING_SOON_COUNT=$((EXPIRING_SOON_COUNT + 1))
                EXPIRING_LIST="${EXPIRING_LIST}\n- Expiration date: $EXPIRATION_DATE"
              else
                echo "✓ Exception with expiration $EXPIRATION_DATE is not expiring soon"
              fi
            fi
          done < "$EXCEPTIONS_FILE"

          # Set outputs
          echo "expired_count=$EXPIRED_COUNT" >> $GITHUB_OUTPUT
          echo "expiring_soon_count=$EXPIRING_SOON_COUNT" >> $GITHUB_OUTPUT

          # Create summary
          echo "## Exception Expiration Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Expired exceptions:** $EXPIRED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Expiring within 30 days:** $EXPIRING_SOON_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ $EXPIRED_COUNT -gt 0 ]]; then
            echo "### ⚠️ Expired Exceptions" >> $GITHUB_STEP_SUMMARY
            echo -e "$EXPIRED_LIST" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ $EXPIRING_SOON_COUNT -gt 0 ]]; then
            echo "### ⏰ Expiring Soon" >> $GITHUB_STEP_SUMMARY
            echo -e "$EXPIRING_LIST" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ $EXPIRED_COUNT -eq 0 && $EXPIRING_SOON_COUNT -eq 0 ]]; then
            echo "✅ No exceptions are expired or expiring soon." >> $GITHUB_STEP_SUMMARY
          fi

          echo ""
          echo "Summary: $EXPIRED_COUNT expired, $EXPIRING_SOON_COUNT expiring soon"

      - name: Create issue for expiring exceptions
        if: steps.check.outputs.expiring_soon_count > 0 && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const expiringCount = ${{ steps.check.outputs.expiring_soon_count }};

            // Check if there's already an open issue for exception expiration
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'exception-expiration'
            });

            if (existingIssues.data.length > 0) {
              console.log('Issue already exists for exception expiration');
              return;
            }

            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⏰ Governance Exception(s) Expiring Soon`,
              body: `## Exception Expiration Alert

            **${expiringCount}** governance exception(s) will expire within the next 30 days.

            ### Action Required

            Please review the [exceptions registry](docs/exceptions.md) and take one of the following actions for each expiring exception:

            1. **Renew** — If the exception is still needed, submit a renewal PR with updated risk assessment
            2. **Retire** — If the exception is no longer needed, move it to the Expired section
            3. **Remediate** — If the underlying issue can be fixed, address it and retire the exception

            ### Process

            - Review [docs/change-control.md](docs/change-control.md) for exception renewal requirements
            - All renewals require re-approval and updated expiration date
            - Exceptions cannot be silently extended

            ---

            *This issue was automatically created by the exception expiration workflow.*`,
              labels: ['exception-expiration', 'governance']
            });

            console.log('Created issue for expiring exceptions');

      - name: Fail on expired exceptions
        if: steps.check.outputs.expired_count > 0
        run: |
          echo "::error::Found ${{ steps.check.outputs.expired_count }} expired exception(s) in the registry"
          echo "Expired exceptions must be moved to the Expired section or renewed."
          echo "See docs/exceptions.md for details."
          exit 1

      - name: Success
        if: steps.check.outputs.expired_count == 0
        run: |
          echo "✅ Exception expiration check passed"
          if [[ "${{ steps.check.outputs.expiring_soon_count }}" -gt 0 ]]; then
            echo "⚠️ Note: ${{ steps.check.outputs.expiring_soon_count }} exception(s) expiring within 30 days"
          fi
